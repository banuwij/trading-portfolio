{% extends "base.html" %}
{% block content %}
<h1 style="margin:0 0 6px;">Trading Case Study Portfolio</h1>
<p style="font-size:13px;color:#9ca3af;margin:0 0 14px;max-width:680px;">
  Live view of my planned, active, and closed trades – each documented as a small case study.
</p>

<div class="card">
  <div style="display:flex;flex-wrap:wrap;gap:18px;align-items:flex-start;">
    <div style="flex:1 1 260px;">
      <h3 style="margin:0 0 4px;">About this journal</h3>
      <p style="font-size:13px;color:#e5e7eb;margin:0 0 10px;">
        I log trades by idea, execution, and review. The goal is to make my decision-making
        transparent, not just the P&amp;L.
      </p>
      <a class="btn-outline" href="https://linkedin.com/in/banuwijaya" target="_blank" rel="noopener noreferrer">
        Hire me on LinkedIn
        <span style="font-size:14px;">↗</span>
      </a>
      <p style="font-size:11px;color:#9ca3af;margin-top:8px;">
        You can export closed trades as CSV for deeper review.
        <a href="{{ url_for('export_closed_csv') }}" style="font-size:11px;">Download CSV &darr;</a>
      </p>
    </div>
    <div style="flex:1 1 260px;">
      <h3 style="margin:0 0 4px;">Snapshot</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;">
        <div>
          <div class="stat-label">Closed trades</div>
          <div class="stat-value">{{ stats.total }}</div>
        </div>
        <div>
          <div class="stat-label">Win rate</div>
          <div class="stat-value">{{ stats.win_rate }}%</div>
        </div>
        <div>
          <div class="stat-label">Avg R:R</div>
          <div class="stat-value">{{ stats.avg_rr }}</div>
        </div>
        <div>
          <div class="stat-label">Avg R / trade</div>
          <div class="stat-value">{{ stats.avg_realized_r }}</div>
        </div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:8px;margin-top:10px;">
        <div>
          <div class="stat-label">Max risk / trade</div>
          <div class="stat-value">{{ stats.max_risk }}%</div>
        </div>
        <div>
          <div class="stat-label">Avg risk</div>
          <div class="stat-value">{{ stats.avg_risk }}%</div>
        </div>
        <div>
          <div class="stat-label">Max drawdown</div>
          <div class="stat-value">{{ stats.max_drawdown }}R</div>
        </div>
        <div>
          <div class="stat-label">Discipline score</div>
          <div class="stat-value">{{ stats.discipline_score }}%</div>
        </div>
      </div>
    </div>
    <div style="flex:1 1 260px;">
      <h3 style="margin:0 0 4px;">About me</h3>
      <p style="font-size:13px;color:#e5e7eb;margin:0 6px 6px 0;">
        I work with markets as a builder and trader: documenting setups, risk, and reviews the way
        I would present it to a desk lead or hiring manager.
      </p>
      <ul style="list-style:none;padding:0;margin:0;font-size:11px;color:#9ca3af;">
        <li>• Markets: Crypto, FX, IDX equities</li>
        <li>• Styles: Swing &amp; intraday case-study journaling</li>
        <li>• Tools: TradingView, Python, custom dashboards</li>
      </ul>
      <p style="font-size:11px;color:#9ca3af;margin:6px 0 0;">
        Status overview: {{ planned_count }} planned · {{ active_count }} active · {{ closed_count }} closed
      </p>
    </div>
  </div>
</div>

{% if playbook %}
  <div class="card">
    <h3 style="margin-top:0;">Strategy playbook</h3>
    <p style="font-size:12px;color:#9ca3af;margin-top:0;">
      Short descriptions of the strategy tags used across this journal.
    </p>
    <div style="display:flex;flex-wrap:wrap;gap:10px;">
      {% for s in playbook %}
        <div style="flex:1 1 220px;border-radius:16px;border:1px solid rgba(31,41,55,0.9);padding:10px 12px;">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
            <span class="chip">{{ s.tag }}</span>
          </div>
          <div style="font-size:12px;color:#e5e7eb;">
            {{ s.description }}
          </div>
        </div>
      {% endfor %}
    </div>
  </div>
{% endif %}

<div class="card">
  <h3 style="margin-top:0;">Filter trades</h3>
  <form method="get">
    <div class="filter-row">
      <div>
        <label>Status</label>
        <select name="status">
          <option value="ALL" {% if filter_status == 'ALL' %}selected{% endif %}>All</option>
          <option value="PLANNED" {% if filter_status == 'PLANNED' %}selected{% endif %}>Planned</option>
          <option value="ACTIVE" {% if filter_status == 'ACTIVE' %}selected{% endif %}>Active</option>
          <option value="CLOSED" {% if filter_status == 'CLOSED' %}selected{% endif %}>Closed</option>
        </select>
      </div>
      <div>
        <label>Direction</label>
        <select name="direction">
          <option value="ALL" {% if filter_direction == 'ALL' %}selected{% endif %}>All</option>
          <option value="BUY" {% if filter_direction == 'BUY' %}selected{% endif %}>Long (Buy)</option>
          <option value="SELL" {% if filter_direction == 'SELL' %}selected{% endif %}>Short (Sell)</option>
        </select>
      </div>
      <div>
        <label>Strategy</label>
        <select name="strategy">
          <option value="ALL" {% if filter_strategy == 'ALL' %}selected{% endif %}>All</option>
          {% for s in unique_strategies %}
            {% set s_up = s.upper() %}
            <option value="{{ s_up }}" {% if filter_strategy == s_up %}selected{% endif %}>{{ s_up }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label>Symbol</label>
        <input type="text" name="symbol" placeholder="e.g. BTCUSDT"
               value="{{ filter_symbol }}">
      </div>
      <button type="submit">Apply</button>
    </div>
    <p style="font-size:11px;color:#9ca3af;margin:2px 0 0;">
      Showing {{ trades|length }} trades · {{ planned_count }} planned · {{ active_count }} active · {{ closed_count }} closed
    </p>
  </form>
</div>

{% if stats.equity_points|length > 0 %}
  <div class="card card-chart">
    <h3 style="margin-top:0;">Equity curve (R-multiple, closed trades)</h3>
    <canvas id="equityChart" height="80"></canvas>
  </div>
{% endif %}

{% if stats.tf_stats %}
  <div class="card">
    <h3 style="margin-top:0;">Timeframe performance (closed trades)</h3>
    <table>
      <thead><tr><th>TF</th><th>Trades</th><th>Win%</th><th>Avg R</th></tr></thead>
      <tbody>
      {% for tf, data in stats.tf_stats.items() %}
        <tr>
          <td>{{ tf }}</td>
          <td>{{ data.count }}</td>
          <td>{{ data.win_rate }}%</td>
          <td>{{ data.avg_r }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

<div class="card">
  <h3 style="margin-top:0;">Trade log (live)</h3>
  <p style="font-size:12px;color:#9ca3af;margin-top:0;">
    Planned, active, and closed trades in one timeline. Click a row to open the full case.
  </p>
  <div style="overflow-x:auto;">
    <table>
      <thead>
      <tr>
        <th>Date</th><th>Symbol</th><th>TF</th><th>Dir</th>
        <th>Status</th>
        <th>Entry</th><th>SL</th><th>TP</th>
        <th>Grade</th><th>Result</th>
        <th>Strategy</th><th>R:R</th><th>R</th>
      </tr>
      </thead>
      <tbody>
      {% for t in trades %}
        <tr onclick="window.location='{{ url_for('trade_detail', trade_id=t['id']) }}'"
            style="cursor:pointer;">
          <td>{{ t['trade_date'] }}</td>
          <td>{{ t['symbol'] }}</td>
          <td>{{ t['timeframe'] }}</td>
          <td>{{ t['direction'] }}</td>
          <td>
            {% set st = (t['status'] or '').upper() %}
            {% if st == 'PLANNED' %}
              <span class="status-badge status-planned">
                <span class="status-dot"></span> Planned
              </span>
            {% elif st == 'ACTIVE' %}
              <span class="status-badge status-active">
                <span class="status-dot"></span> Active
              </span>
            {% elif st == 'CLOSED' %}
              <span class="status-badge status-closed">
                <span class="status-dot"></span> Closed
              </span>
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ t['entry_price'] }}</td>
          <td>{{ t['stop_loss'] }}</td>
          <td>{{ t['take_profit'] }}</td>
          <td><span class="grade">{{ t['grade'] or '-' }}</span></td>
          <td>
            {% if (t['result'] or '').upper() == 'WIN' %}
              <span class="badge badge-win">WIN</span>
            {% elif (t['result'] or '').upper() == 'LOSE' %}
              <span class="badge badge-lose">LOSE</span>
            {% else %}
              -
            {% endif %}
          </td>
          <td>{{ t['strategy_tag'] }}</td>
          <td>{{ '%.2f'|format(t['rr_ratio']) if t['rr_ratio'] is not none else '-' }}</td>
          <td>{{ '%.2f'|format(t['realized_r']) if t['realized_r'] is not none else '-' }}</td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% if stats.equity_points|length > 0 %}
<script>
  const labels = {{ stats.equity_labels|tojson }};
  const dataPoints = {{ stats.equity_points|tojson }};
  const ctx = document.getElementById('equityChart').getContext('2d');
  new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        data: dataPoints,
        tension: 0.35,
        borderColor: '#38bdf8',
        backgroundColor: 'rgba(56,189,248,0.16)',
        borderWidth: 2,
        pointRadius: 0,
        fill: true
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display:false } },
      scales: {
        x: { display:false },
        y: {
          ticks: { color:'#9ca3af', font:{ size:11 } },
          grid: { color:'rgba(31,41,55,0.7)' }
        }
      }
    }
  });
</script>
{% endif %}
{% endblock %}
